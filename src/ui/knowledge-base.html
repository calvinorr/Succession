<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base | Succession</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500;9..144,600;9..144,700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ink': {
                            50: '#f6f7f9', 100: '#eceef2', 200: '#d5dae3', 300: '#b0b9cb',
                            400: '#8592ae', 500: '#667594', 600: '#515d7a', 700: '#434c64',
                            800: '#3a4254', 900: '#333948', 950: '#22252f',
                        },
                        'paper': '#fdfcfa',
                        'cream': '#f9f7f3',
                        'freq': {
                            daily: { bg: '#fef2f2', text: '#991b1b', border: '#fecaca' },
                            weekly: { bg: '#fff7ed', text: '#9a3412', border: '#fed7aa' },
                            monthly: { bg: '#eff6ff', text: '#1e40af', border: '#bfdbfe' },
                            quarterly: { bg: '#faf5ff', text: '#6b21a8', border: '#e9d5ff' },
                            annual: { bg: '#f0fdf4', text: '#166534', border: '#bbf7d0' },
                            'ad-hoc': { bg: '#f8fafc', text: '#475569', border: '#e2e8f0' },
                        }
                    },
                    fontFamily: {
                        'display': ['Fraunces', 'serif'],
                        'body': ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 1px 2px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.04)',
                        'lifted': '0 4px 24px -4px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(12px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateX(-8px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d5dae3; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0b9cb; }

        /* Search highlight */
        .search-highlight {
            background: linear-gradient(120deg, #fef08a 0%, #fde047 100%);
            padding: 0.1em 0.2em;
            border-radius: 2px;
            box-decoration-break: clone;
        }

        /* Section icons */
        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Print styles */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            .knowledge-card {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #e5e7eb !important;
            }
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; }
        }

        /* Topic card hover */
        .topic-card {
            transition: all 0.2s ease;
        }
        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px -8px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.04);
        }

        /* Frequency pill styles */
        .freq-daily { background: #fef2f2; color: #991b1b; border-color: #fecaca; }
        .freq-weekly { background: #fff7ed; color: #9a3412; border-color: #fed7aa; }
        .freq-monthly { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        .freq-quarterly { background: #faf5ff; color: #6b21a8; border-color: #e9d5ff; }
        .freq-annual { background: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .freq-ad-hoc { background: #f8fafc; color: #475569; border-color: #e2e8f0; }

        /* Detail panel slide */
        .detail-panel {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .detail-panel.hidden {
            transform: translateX(100%);
            opacity: 0;
        }

        /* Staggered animations */
        .stagger-1 { animation-delay: 0.05s; }
        .stagger-2 { animation-delay: 0.1s; }
        .stagger-3 { animation-delay: 0.15s; }
        .stagger-4 { animation-delay: 0.2s; }
        .stagger-5 { animation-delay: 0.25s; }
    </style>
</head>

<body class="bg-cream font-body text-ink-800 min-h-screen">

    <!-- Sidebar Navigation -->
    <aside class="sidebar fixed left-0 top-0 w-64 h-full bg-paper border-r border-ink-200/60 flex flex-col z-40 no-print">
        <div class="flex flex-col h-full p-5">
            <!-- Logo -->
            <div class="flex items-center gap-3 mb-8 px-1">
                <div class="w-10 h-10 rounded-xl bg-ink-900 flex items-center justify-center">
                    <span class="material-symbols-outlined text-paper text-xl">menu_book</span>
                </div>
                <div>
                    <h1 class="font-display text-xl text-ink-900 font-semibold tracking-tight">Knowledge Base</h1>
                    <p class="text-[10px] uppercase tracking-[0.15em] text-ink-400 font-medium">Finance Procedures</p>
                </div>
            </div>

            <!-- Quick Filters -->
            <div class="mb-6">
                <p class="text-xs font-semibold uppercase tracking-wider text-ink-400 mb-3 px-1">Filter by Frequency</p>
                <div class="space-y-1" id="frequency-filters">
                    <button onclick="setFilter('all')" data-filter="all" class="filter-btn active w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all bg-ink-100 text-ink-800">
                        <span class="material-symbols-outlined text-[18px]">filter_list_off</span>
                        <span class="text-sm font-medium">All Topics</span>
                        <span class="ml-auto text-xs font-semibold bg-ink-200 text-ink-600 px-2 py-0.5 rounded-full" id="count-all">0</span>
                    </button>
                    <button onclick="setFilter('daily')" data-filter="daily" class="filter-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all hover:bg-ink-50 text-ink-600">
                        <span class="w-2 h-2 rounded-full bg-red-500"></span>
                        <span class="text-sm font-medium">Daily</span>
                        <span class="ml-auto text-xs font-medium text-ink-400" id="count-daily">0</span>
                    </button>
                    <button onclick="setFilter('weekly')" data-filter="weekly" class="filter-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all hover:bg-ink-50 text-ink-600">
                        <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                        <span class="text-sm font-medium">Weekly</span>
                        <span class="ml-auto text-xs font-medium text-ink-400" id="count-weekly">0</span>
                    </button>
                    <button onclick="setFilter('monthly')" data-filter="monthly" class="filter-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all hover:bg-ink-50 text-ink-600">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span class="text-sm font-medium">Monthly</span>
                        <span class="ml-auto text-xs font-medium text-ink-400" id="count-monthly">0</span>
                    </button>
                    <button onclick="setFilter('quarterly')" data-filter="quarterly" class="filter-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all hover:bg-ink-50 text-ink-600">
                        <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                        <span class="text-sm font-medium">Quarterly</span>
                        <span class="ml-auto text-xs font-medium text-ink-400" id="count-quarterly">0</span>
                    </button>
                    <button onclick="setFilter('annual')" data-filter="annual" class="filter-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all hover:bg-ink-50 text-ink-600">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span class="text-sm font-medium">Annual</span>
                        <span class="ml-auto text-xs font-medium text-ink-400" id="count-annual">0</span>
                    </button>
                    <button onclick="setFilter('ad-hoc')" data-filter="ad-hoc" class="filter-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-all hover:bg-ink-50 text-ink-600">
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                        <span class="text-sm font-medium">Ad-hoc</span>
                        <span class="ml-auto text-xs font-medium text-ink-400" id="count-ad-hoc">0</span>
                    </button>
                </div>
            </div>

            <div class="flex-1"></div>

            <!-- Actions -->
            <div class="space-y-2 border-t border-ink-200/60 pt-4">
                <button onclick="window.print()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-ink-500 hover:text-ink-700 hover:bg-ink-50 transition-all">
                    <span class="material-symbols-outlined text-[18px]">print</span>
                    <span class="text-sm font-medium">Print Manual</span>
                </button>
                <a href="index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg text-ink-500 hover:text-ink-700 hover:bg-ink-50 transition-all">
                    <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                    <span class="text-sm font-medium">Back to App</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content ml-64 min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 bg-cream/95 backdrop-blur-sm border-b border-ink-200/40 z-30 no-print">
            <div class="max-w-5xl mx-auto px-8 py-5">
                <div class="flex items-center gap-6">
                    <!-- Search -->
                    <div class="flex-1 relative">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-ink-400 text-[20px]">search</span>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Search procedures, contacts, systems..."
                            class="w-full h-12 pl-12 pr-4 rounded-xl bg-paper border border-ink-200/80 text-ink-800 placeholder:text-ink-400 focus:outline-none focus:border-ink-400 focus:ring-4 focus:ring-ink-100 transition-all"
                            oninput="handleSearch(this.value)"
                        >
                        <kbd class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-medium text-ink-400 bg-ink-100 px-2 py-1 rounded border border-ink-200/60 hidden sm:block">/</kbd>
                    </div>
                    <!-- View Toggle -->
                    <div class="flex items-center gap-1 bg-paper border border-ink-200/80 rounded-lg p-1">
                        <button onclick="setView('grid')" id="view-grid" class="view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-ink-900 text-paper">
                            <span class="material-symbols-outlined text-[18px]">grid_view</span>
                        </button>
                        <button onclick="setView('list')" id="view-list" class="view-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all text-ink-500 hover:text-ink-700">
                            <span class="material-symbols-outlined text-[18px]">view_list</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="max-w-5xl mx-auto px-8 py-8">
            <!-- Page Title -->
            <div class="mb-8 animate-fade-in">
                <h1 class="font-display text-3xl text-ink-900 font-semibold mb-2">Finance Procedures Manual</h1>
                <p class="text-ink-500">Documented knowledge and procedures for local authority finance operations.</p>
            </div>

            <!-- Search Results Info -->
            <div id="search-info" class="hidden mb-6 animate-slide-up">
                <div class="flex items-center justify-between">
                    <p class="text-sm text-ink-500">
                        <span id="result-count">0</span> results for "<span id="search-term" class="font-medium text-ink-700"></span>"
                    </p>
                    <button onclick="clearSearch()" class="text-sm font-medium text-ink-600 hover:text-ink-800 flex items-center gap-1">
                        <span class="material-symbols-outlined text-[16px]">close</span>
                        Clear search
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden py-16 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-ink-100 flex items-center justify-center">
                    <span class="material-symbols-outlined text-ink-400 text-3xl">search_off</span>
                </div>
                <h3 class="font-display text-xl text-ink-700 mb-2">No topics found</h3>
                <p class="text-ink-500 max-w-sm mx-auto">Try adjusting your search or filter to find what you're looking for.</p>
            </div>

            <!-- No Knowledge Entries State -->
            <div id="no-entries-state" class="hidden py-16 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-ink-100 flex items-center justify-center">
                    <span class="material-symbols-outlined text-ink-400 text-3xl">auto_stories</span>
                </div>
                <h3 class="font-display text-xl text-ink-700 mb-2">Knowledge base is empty</h3>
                <p class="text-ink-500 max-w-sm mx-auto mb-6">Complete interviews and synthesize them to build your procedures manual.</p>
                <a href="topics.html" class="inline-flex items-center gap-2 px-5 py-2.5 bg-ink-900 text-paper rounded-lg font-medium hover:bg-ink-800 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    Add Topics
                </a>
            </div>

            <!-- Topics Grid -->
            <div id="topics-grid" class="grid gap-4 grid-cols-1 md:grid-cols-2">
                <!-- Topic cards rendered here -->
            </div>

            <!-- Topics List -->
            <div id="topics-list" class="hidden space-y-3">
                <!-- Topic list items rendered here -->
            </div>
        </div>
    </main>

    <!-- Detail Panel (Slide-over) -->
    <div id="detail-overlay" class="fixed inset-0 bg-ink-900/20 backdrop-blur-sm z-50 hidden no-print" onclick="closeDetail()"></div>
    <aside id="detail-panel" class="detail-panel fixed right-0 top-0 w-full max-w-2xl h-full bg-paper shadow-2xl z-50 overflow-hidden hidden no-print">
        <div class="h-full flex flex-col">
            <!-- Panel Header -->
            <header class="flex items-center justify-between px-6 py-4 border-b border-ink-200/60">
                <div class="flex items-center gap-3">
                    <span id="detail-freq-badge" class="freq-monthly px-2.5 py-1 text-xs font-semibold rounded-full border"></span>
                    <h2 id="detail-title" class="font-display text-xl text-ink-900 font-semibold">Topic Name</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="printTopic()" class="p-2 rounded-lg text-ink-500 hover:text-ink-700 hover:bg-ink-100 transition-all" title="Print this topic">
                        <span class="material-symbols-outlined text-[20px]">print</span>
                    </button>
                    <button onclick="closeDetail()" class="p-2 rounded-lg text-ink-500 hover:text-ink-700 hover:bg-ink-100 transition-all">
                        <span class="material-symbols-outlined text-[20px]">close</span>
                    </button>
                </div>
            </header>

            <!-- Panel Content -->
            <div id="detail-content" class="flex-1 overflow-y-auto p-6">
                <!-- Sections rendered here -->
            </div>

            <!-- Related Topics -->
            <div id="related-topics" class="hidden border-t border-ink-200/60 px-6 py-4 bg-ink-50/50">
                <p class="text-xs font-semibold uppercase tracking-wider text-ink-400 mb-3">Related Topics</p>
                <div id="related-list" class="flex flex-wrap gap-2">
                    <!-- Related topic links -->
                </div>
            </div>
        </div>
    </aside>

    <script>
        // State
        let knowledgeEntries = [];
        let topics = [];
        let currentFilter = 'all';
        let currentSearch = '';
        let currentView = 'grid';

        // Section definitions with icons and colors
        const SECTIONS = {
            overview: { icon: 'info', color: 'bg-blue-100 text-blue-600', label: 'Overview' },
            frequency: { icon: 'schedule', color: 'bg-purple-100 text-purple-600', label: 'Frequency' },
            keyTasks: { icon: 'checklist', color: 'bg-emerald-100 text-emerald-600', label: 'Key Tasks' },
            keyDates: { icon: 'event', color: 'bg-red-100 text-red-600', label: 'Key Dates' },
            contacts: { icon: 'contacts', color: 'bg-amber-100 text-amber-600', label: 'Contacts' },
            systemsAndTools: { icon: 'build', color: 'bg-slate-100 text-slate-600', label: 'Systems & Tools' },
            watchOutFor: { icon: 'warning', color: 'bg-orange-100 text-orange-600', label: 'Watch Out For' },
            proTips: { icon: 'lightbulb', color: 'bg-yellow-100 text-yellow-600', label: 'Pro Tips' },
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            render();

            // Keyboard shortcut for search
            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }
                if (e.key === 'Escape') {
                    closeDetail();
                    clearSearch();
                }
            });
        });

        // Load data from API
        async function loadData() {
            try {
                const [entriesRes, topicsRes] = await Promise.all([
                    fetch('/knowledge-entries'),
                    fetch('/topics')
                ]);
                knowledgeEntries = await entriesRes.json();
                topics = await topicsRes.json();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Get topic info by ID
        function getTopic(topicId) {
            return topics.find(t => t.id === topicId) || {};
        }

        // Filter and search entries
        function getFilteredEntries() {
            let filtered = knowledgeEntries;

            // Apply frequency filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(entry => {
                    const topic = getTopic(entry.topicId);
                    return topic.frequency === currentFilter;
                });
            }

            // Apply search
            if (currentSearch.trim()) {
                const search = currentSearch.toLowerCase();
                filtered = filtered.filter(entry => {
                    const searchableText = [
                        entry.topicName,
                        entry.sections?.overview,
                        entry.sections?.frequency,
                        ...(entry.sections?.keyTasks || []),
                        ...(entry.sections?.keyDates || []),
                        ...(entry.sections?.contacts || []),
                        ...(entry.sections?.systemsAndTools || []),
                        ...(entry.sections?.watchOutFor || []),
                        ...(entry.sections?.proTips || []),
                    ].join(' ').toLowerCase();
                    return searchableText.includes(search);
                });
            }

            return filtered;
        }

        // Update filter counts
        function updateCounts() {
            const countByFreq = { all: knowledgeEntries.length };
            ['daily', 'weekly', 'monthly', 'quarterly', 'annual', 'ad-hoc'].forEach(freq => {
                countByFreq[freq] = knowledgeEntries.filter(e => {
                    const topic = getTopic(e.topicId);
                    return topic.frequency === freq;
                }).length;
            });

            document.getElementById('count-all').textContent = countByFreq.all;
            document.getElementById('count-daily').textContent = countByFreq.daily;
            document.getElementById('count-weekly').textContent = countByFreq.weekly;
            document.getElementById('count-monthly').textContent = countByFreq.monthly;
            document.getElementById('count-quarterly').textContent = countByFreq.quarterly;
            document.getElementById('count-annual').textContent = countByFreq.annual;
            document.getElementById('count-ad-hoc').textContent = countByFreq['ad-hoc'];
        }

        // Set frequency filter
        function setFilter(filter) {
            currentFilter = filter;

            // Update active state
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.filter === filter;
                btn.classList.toggle('bg-ink-100', isActive);
                btn.classList.toggle('text-ink-800', isActive);
                btn.classList.toggle('text-ink-600', !isActive);
            });

            render();
        }

        // Set view mode
        function setView(view) {
            currentView = view;

            document.getElementById('view-grid').classList.toggle('bg-ink-900', view === 'grid');
            document.getElementById('view-grid').classList.toggle('text-paper', view === 'grid');
            document.getElementById('view-grid').classList.toggle('text-ink-500', view !== 'grid');

            document.getElementById('view-list').classList.toggle('bg-ink-900', view === 'list');
            document.getElementById('view-list').classList.toggle('text-paper', view === 'list');
            document.getElementById('view-list').classList.toggle('text-ink-500', view !== 'list');

            render();
        }

        // Handle search input
        function handleSearch(value) {
            currentSearch = value;

            const searchInfo = document.getElementById('search-info');
            if (value.trim()) {
                searchInfo.classList.remove('hidden');
                document.getElementById('search-term').textContent = value;
            } else {
                searchInfo.classList.add('hidden');
            }

            render();
        }

        // Clear search
        function clearSearch() {
            currentSearch = '';
            document.getElementById('search-input').value = '';
            document.getElementById('search-info').classList.add('hidden');
            render();
        }

        // Highlight search terms in text
        function highlightText(text, search) {
            if (!search.trim() || !text) return text;
            const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Render the UI
        function render() {
            updateCounts();

            const filtered = getFilteredEntries();
            const grid = document.getElementById('topics-grid');
            const list = document.getElementById('topics-list');
            const emptyState = document.getElementById('empty-state');
            const noEntriesState = document.getElementById('no-entries-state');

            // Update result count
            document.getElementById('result-count').textContent = filtered.length;

            // Show appropriate state
            if (knowledgeEntries.length === 0) {
                grid.classList.add('hidden');
                list.classList.add('hidden');
                emptyState.classList.add('hidden');
                noEntriesState.classList.remove('hidden');
                return;
            }

            noEntriesState.classList.add('hidden');

            if (filtered.length === 0) {
                grid.classList.add('hidden');
                list.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Render based on view
            if (currentView === 'grid') {
                grid.classList.remove('hidden');
                list.classList.add('hidden');
                grid.innerHTML = filtered.map((entry, i) => renderGridCard(entry, i)).join('');
            } else {
                grid.classList.add('hidden');
                list.classList.remove('hidden');
                list.innerHTML = filtered.map((entry, i) => renderListItem(entry, i)).join('');
            }
        }

        // Render grid card
        function renderGridCard(entry, index) {
            const topic = getTopic(entry.topicId);
            const freq = topic.frequency || 'ad-hoc';
            const overview = entry.sections?.overview || 'No overview available.';
            const taskCount = entry.sections?.keyTasks?.length || 0;

            return `
                <article class="topic-card knowledge-card bg-paper rounded-xl border border-ink-200/60 shadow-soft overflow-hidden cursor-pointer animate-slide-up stagger-${Math.min(index + 1, 5)}" onclick="openDetail('${entry.id}')">
                    <div class="p-5">
                        <div class="flex items-start justify-between mb-3">
                            <span class="freq-${freq} px-2.5 py-1 text-xs font-semibold rounded-full border">${freq}</span>
                            <span class="material-symbols-outlined text-ink-300 text-[18px]">arrow_forward</span>
                        </div>
                        <h3 class="font-display text-lg text-ink-900 font-semibold mb-2">${highlightText(entry.topicName, currentSearch)}</h3>
                        <p class="text-sm text-ink-500 line-clamp-2 mb-4">${highlightText(overview, currentSearch)}</p>
                        <div class="flex items-center gap-4 text-xs text-ink-400">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">checklist</span>
                                ${taskCount} tasks
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">schedule</span>
                                ${entry.sections?.frequency || 'Not specified'}
                            </span>
                        </div>
                    </div>
                </article>
            `;
        }

        // Render list item
        function renderListItem(entry, index) {
            const topic = getTopic(entry.topicId);
            const freq = topic.frequency || 'ad-hoc';
            const overview = entry.sections?.overview || 'No overview available.';

            return `
                <article class="topic-card knowledge-card bg-paper rounded-xl border border-ink-200/60 shadow-soft overflow-hidden cursor-pointer animate-slide-in stagger-${Math.min(index + 1, 5)}" onclick="openDetail('${entry.id}')">
                    <div class="p-4 flex items-center gap-4">
                        <span class="freq-${freq} px-2.5 py-1 text-xs font-semibold rounded-full border flex-shrink-0">${freq}</span>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-display text-base text-ink-900 font-semibold truncate">${highlightText(entry.topicName, currentSearch)}</h3>
                            <p class="text-sm text-ink-500 truncate">${highlightText(overview, currentSearch)}</p>
                        </div>
                        <span class="material-symbols-outlined text-ink-300 text-[18px] flex-shrink-0">arrow_forward</span>
                    </div>
                </article>
            `;
        }

        // Open detail panel
        function openDetail(entryId) {
            const entry = knowledgeEntries.find(e => e.id === entryId);
            if (!entry) return;

            const topic = getTopic(entry.topicId);
            const freq = topic.frequency || 'ad-hoc';

            // Update header
            document.getElementById('detail-title').textContent = entry.topicName;
            const badge = document.getElementById('detail-freq-badge');
            badge.textContent = freq;
            badge.className = `freq-${freq} px-2.5 py-1 text-xs font-semibold rounded-full border`;

            // Render sections
            const content = document.getElementById('detail-content');
            content.innerHTML = renderDetailSections(entry.sections);

            // Render related topics
            const relatedContainer = document.getElementById('related-topics');
            const relatedList = document.getElementById('related-list');

            if (entry.crossReferences && entry.crossReferences.length > 0) {
                relatedContainer.classList.remove('hidden');
                relatedList.innerHTML = entry.crossReferences.map(ref => `
                    <button onclick="openDetail('${ref.topicId}')" class="px-3 py-1.5 bg-paper border border-ink-200 rounded-lg text-sm font-medium text-ink-600 hover:border-ink-400 hover:text-ink-800 transition-all flex items-center gap-1.5" ${!ref.topicId ? 'disabled' : ''}>
                        <span class="material-symbols-outlined text-[14px]">link</span>
                        ${ref.topicName}
                    </button>
                `).join('');
            } else {
                relatedContainer.classList.add('hidden');
            }

            // Show panel
            document.getElementById('detail-overlay').classList.remove('hidden');
            document.getElementById('detail-panel').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Render detail sections
        function renderDetailSections(sections) {
            if (!sections) return '<p class="text-ink-500">No content available.</p>';

            return Object.entries(SECTIONS).map(([key, config]) => {
                const value = sections[key];
                if (!value || (Array.isArray(value) && value.length === 0)) return '';

                let contentHtml;
                if (Array.isArray(value)) {
                    if (value.length === 1 && value[0] === 'Not covered in interview') {
                        contentHtml = `<p class="text-ink-400 italic">Not covered in interview</p>`;
                    } else {
                        contentHtml = `
                            <ul class="space-y-2">
                                ${value.map((item, i) => `
                                    <li class="flex gap-3 text-ink-700">
                                        <span class="text-ink-400 font-medium text-sm">${String(i + 1).padStart(2, '0')}</span>
                                        <span>${highlightText(item, currentSearch)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }
                } else {
                    if (value === 'Not covered in interview') {
                        contentHtml = `<p class="text-ink-400 italic">Not covered in interview</p>`;
                    } else {
                        contentHtml = `<p class="text-ink-700 leading-relaxed">${highlightText(value, currentSearch)}</p>`;
                    }
                }

                return `
                    <section class="mb-6 last:mb-0">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="section-icon ${config.color}">
                                <span class="material-symbols-outlined text-[18px]">${config.icon}</span>
                            </div>
                            <h3 class="font-display text-base text-ink-900 font-semibold">${config.label}</h3>
                        </div>
                        <div class="pl-11">
                            ${contentHtml}
                        </div>
                    </section>
                `;
            }).join('');
        }

        // Close detail panel
        function closeDetail() {
            document.getElementById('detail-overlay').classList.add('hidden');
            document.getElementById('detail-panel').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Print current topic
        function printTopic() {
            window.print();
        }
    </script>
</body>
</html>
