<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Succession | Interviews</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': {
                            50: '#eef4ff', 100: '#d9e5ff', 200: '#bcd2ff', 300: '#8eb5ff',
                            400: '#598eff', 500: '#3366ff', 600: '#1a44f5', 700: '#1333e1',
                            800: '#162bb6', 900: '#182a8f',
                        },
                        'surface': {
                            0: '#ffffff', 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0',
                            300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569',
                            700: '#334155', 800: '#1e293b', 900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'display': ['"DM Serif Display"', 'serif'],
                        'body': ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 40px -10px rgba(51, 102, 255, 0.3)',
                        'card': '0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04)',
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>

    <!-- Mermaid.js for workflow diagrams (Story 5.4) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'base', themeVariables: {
            primaryColor: '#3366ff',
            primaryTextColor: '#1e293b',
            primaryBorderColor: '#bcd2ff',
            lineColor: '#64748b',
            secondaryColor: '#f1f5f9',
            tertiaryColor: '#eef4ff'
        }});
    </script>
</head>

<body class="bg-surface-50 font-body text-surface-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-surface-0 border-r border-surface-200/80 flex flex-col h-full flex-shrink-0">
        <div class="flex flex-col h-full p-5">
            <!-- Logo -->
            <div class="flex items-center gap-3 mb-10 px-1">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center shadow-glow">
                    <span class="material-symbols-outlined text-white text-xl">hub</span>
                </div>
                <div>
                    <h1 class="font-display text-xl text-surface-900 tracking-tight">Succession</h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] text-surface-400 font-medium">Expert Systems</p>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex flex-col gap-1 flex-1">
                <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-surface-700 hover:bg-surface-100 transition-all">
                    <span class="material-symbols-outlined text-[20px]">space_dashboard</span>
                    <span class="text-sm font-medium">Dashboard</span>
                </a>
                <a href="index.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-brand-50 text-brand-600 transition-all">
                    <span class="material-symbols-outlined filled text-[20px]">mic</span>
                    <span class="text-sm font-semibold">Interviews</span>
                </a>
                <a href="personas.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-surface-700 hover:bg-surface-100 transition-all">
                    <span class="material-symbols-outlined text-[20px]">person_search</span>
                    <span class="text-sm font-medium">Personas</span>
                </a>
                <a href="knowledge-base.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-surface-700 hover:bg-surface-100 transition-all">
                    <span class="material-symbols-outlined text-[20px]">menu_book</span>
                    <span class="text-sm font-medium">Knowledge Base</span>
                </a>
                <a href="qa.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-surface-700 hover:bg-surface-100 transition-all">
                    <span class="material-symbols-outlined text-[20px]">verified</span>
                    <span class="text-sm font-medium">QA Testing</span>
                </a>
                <div class="flex-1"></div>
                <a href="admin.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-surface-700 hover:bg-surface-100 transition-all">
                    <span class="material-symbols-outlined text-[20px]">admin_panel_settings</span>
                    <span class="text-sm font-medium">Admin</span>
                </a>
            </nav>

            <!-- User -->
            <div class="border-t border-surface-200/80 pt-5 mt-4">
                <div class="flex items-center gap-3 px-1">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center text-white font-semibold text-sm">CU</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-surface-800 truncate">Calvin User</p>
                        <p class="text-xs text-surface-400 truncate">admin@succession.io</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden">

        <!-- Start Section (shown when no interview active) -->
        <div id="start-section" class="flex-1 flex items-center justify-center p-8">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center shadow-glow">
                        <span class="material-symbols-outlined text-white text-3xl">mic</span>
                    </div>
                    <h1 class="font-display text-3xl text-surface-900 mb-2">Start Interview</h1>
                    <p class="text-surface-500">Select an expert role to begin capturing knowledge</p>
                </div>

                <div class="bg-surface-0 rounded-2xl border border-surface-200/60 shadow-card p-6">
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Expert Role</label>
                    <select id="role-select" class="w-full h-12 px-4 rounded-xl bg-surface-100 border-0 text-surface-700 font-medium focus:outline-none focus:ring-2 focus:ring-brand-500/20 cursor-pointer mb-4">
                        <option value="">Select an expert role...</option>
                        <option value="Finance Director">Finance Director</option>
                        <option value="Head of AP">Head of AP</option>
                        <option value="Head of AR">Head of AR</option>
                        <option value="Head of Treasury">Head of Treasury</option>
                    </select>

                    <button id="start-button" class="w-full h-12 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-xl font-semibold shadow-lg shadow-brand-500/25 hover:shadow-brand-500/40 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-[20px]">play_arrow</span>
                        Start Interview
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Section (shown when interview active) -->
        <div id="chat-section" class="flex-1 flex h-full hidden">

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col h-full">
                <!-- Chat Header -->
                <header class="px-6 py-4 bg-surface-0 border-b border-surface-200/60 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-white">person</span>
                        </div>
                        <div>
                            <h2 class="font-semibold text-surface-800">Interview: <span id="role-display" class="text-brand-600"></span></h2>
                            <p id="phase-display" class="text-xs text-surface-400 uppercase tracking-wider">Phase: Warm-up</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleTopicSidebar()" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-surface-200 text-surface-600 hover:bg-surface-50 hover:border-purple-300 hover:text-purple-600 transition-all text-sm font-medium">
                            <span class="material-symbols-outlined text-[18px]">checklist</span>
                            Topics
                        </button>
                        <button onclick="toggleReviewSidebar()" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-surface-200 text-surface-600 hover:bg-surface-50 hover:border-amber-300 hover:text-amber-600 transition-all text-sm font-medium">
                            <span class="material-symbols-outlined text-[18px]">fact_check</span>
                            Review
                        </button>
                        <button onclick="showSummaryModal()" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-surface-200 text-surface-600 hover:bg-surface-50 hover:border-emerald-300 hover:text-emerald-600 transition-all text-sm font-medium">
                            <span class="material-symbols-outlined text-[18px]">summarize</span>
                            Summary
                        </button>
                        <button onclick="createSnapshot()" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-surface-200 text-surface-600 hover:bg-surface-50 hover:border-brand-300 hover:text-brand-600 transition-all text-sm font-medium">
                            <span class="material-symbols-outlined text-[18px]">photo_camera</span>
                            Snapshot
                        </button>
                        <button id="build-persona-btn" onclick="buildPersona()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-brand-600 hover:bg-brand-700 text-white transition-colors text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed" title="Cover 70% of topics first">
                            <span class="material-symbols-outlined text-[18px]">auto_awesome</span>
                            <span id="build-persona-text">Build Persona</span>
                        </button>
                    </div>
                </header>

                <!-- Chat Messages -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Messages populated here -->
                </div>

                <!-- Chat Input -->
                <div class="p-4 bg-surface-0 border-t border-surface-200/60">
                    <div class="max-w-4xl mx-auto flex gap-3">
                        <input type="text" id="message-input" placeholder="Type your response as the expert..." class="flex-1 h-12 px-5 rounded-xl bg-surface-100 border-0 text-surface-700 placeholder:text-surface-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:bg-surface-0 transition-all">
                        <button id="send-button" class="h-12 px-6 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-xl font-semibold shadow-lg shadow-brand-500/25 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="material-symbols-outlined text-[18px]">send</span>
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Topic Progress Sidebar (Story 5.2) -->
            <aside id="topic-sidebar" class="w-80 bg-surface-0 border-l border-surface-200/60 flex-col h-full overflow-hidden hidden">
                <!-- Sidebar Header -->
                <div class="px-4 py-4 border-b border-surface-200/60 bg-gradient-to-r from-purple-50 to-surface-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-500">checklist</span>
                            <h3 class="font-semibold text-surface-800">Topic Progress</h3>
                        </div>
                        <button onclick="toggleTopicSidebar()" class="p-1 hover:bg-surface-100 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-surface-400 text-[20px]">close</span>
                        </button>
                    </div>
                    <div class="mt-3">
                        <div class="flex items-center justify-between text-sm mb-1">
                            <span class="text-surface-500">Overall Progress</span>
                            <span id="topic-progress-text" class="font-semibold text-surface-700">0/9</span>
                        </div>
                        <div class="w-full bg-surface-200 rounded-full h-2">
                            <div id="topic-progress-bar" class="h-2 rounded-full bg-purple-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Topic List -->
                <div id="topic-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                    <!-- Topics populated by JS -->
                    <div class="text-center text-surface-400 py-8">
                        <span class="material-symbols-outlined text-3xl mb-2 block">hourglass_empty</span>
                        Loading topics...
                    </div>
                </div>

                <!-- Sidebar Footer -->
                <div class="px-4 py-3 border-t border-surface-200/60 bg-surface-50 space-y-3">
                    <!-- Coverage threshold indicator -->
                    <div id="coverage-indicator" class="text-center">
                        <div class="flex items-center justify-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-amber-500 text-[18px]">info</span>
                            <span class="text-surface-600">Cover <span class="font-semibold">70%</span> of topics to build persona</span>
                        </div>
                    </div>
                    <!-- Take a Break button -->
                    <button onclick="takeBreak()" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl border border-surface-200 text-surface-600 hover:bg-surface-100 hover:border-surface-300 transition-all text-sm font-medium">
                        <span class="material-symbols-outlined text-[18px]">coffee</span>
                        Save & Take a Break
                    </button>
                    <p class="text-xs text-surface-400 text-center">
                        Your progress is auto-saved
                    </p>
                </div>
            </aside>

            <!-- Knowledge Review Sidebar (Story 5.3) -->
            <aside id="review-sidebar" class="w-96 bg-surface-0 border-l border-surface-200/60 flex-col h-full overflow-hidden hidden">
                <!-- Sidebar Header -->
                <div class="px-4 py-4 border-b border-surface-200/60 bg-gradient-to-r from-amber-50 to-surface-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-amber-500">fact_check</span>
                            <h3 class="font-semibold text-surface-800">Review Knowledge</h3>
                        </div>
                        <button onclick="toggleReviewSidebar()" class="p-1 hover:bg-surface-100 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-surface-400 text-[20px]">close</span>
                        </button>
                    </div>
                    <div class="mt-3">
                        <div class="flex items-center justify-between text-sm mb-1">
                            <span class="text-surface-500">Knowledge Points</span>
                            <span id="review-points-text" class="font-semibold text-surface-700">0 points</span>
                        </div>
                        <div class="flex gap-2 text-xs">
                            <span id="review-draft-count" class="px-2 py-0.5 bg-surface-100 text-surface-500 rounded-full">0 draft</span>
                            <span id="review-reviewed-count" class="px-2 py-0.5 bg-amber-100 text-amber-600 rounded-full">0 reviewed</span>
                            <span id="review-approved-count" class="px-2 py-0.5 bg-emerald-100 text-emerald-600 rounded-full">0 approved</span>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Points List -->
                <div id="review-list" class="flex-1 overflow-y-auto p-3 space-y-3">
                    <div class="text-center text-surface-400 py-8">
                        <span class="material-symbols-outlined text-3xl mb-2 block">hourglass_empty</span>
                        Loading knowledge points...
                    </div>
                </div>

                <!-- Sidebar Footer -->
                <div class="px-4 py-3 border-t border-surface-200/60 bg-surface-50">
                    <button onclick="addKnowledgePoint()" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-amber-500 hover:bg-amber-600 text-white transition-all text-sm font-semibold">
                        <span class="material-symbols-outlined text-[18px]">add</span>
                        Add Knowledge Point
                    </button>
                </div>
            </aside>
        </div>
    </main>

    <!-- Add Knowledge Point Modal (Story 5.3) -->
    <div id="add-point-modal" class="fixed inset-0 bg-surface-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface-0 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
            <div class="px-6 py-4 border-b border-surface-200 bg-gradient-to-r from-amber-50 to-surface-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-white">add_circle</span>
                        </div>
                        <div>
                            <h2 class="font-display text-xl text-surface-900">Add Knowledge Point</h2>
                            <p class="text-sm text-surface-500">Capture missing information</p>
                        </div>
                    </div>
                    <button onclick="closeAddPointModal()" class="p-2 hover:bg-surface-100 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-surface-400">close</span>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Topic</label>
                    <select id="add-point-topic" class="w-full h-10 px-3 rounded-lg bg-surface-100 border-0 text-surface-700 focus:outline-none focus:ring-2 focus:ring-amber-500/20">
                        <option value="general">General Knowledge</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Knowledge Area</label>
                    <select id="add-point-area" class="w-full h-10 px-3 rounded-lg bg-surface-100 border-0 text-surface-700 focus:outline-none focus:ring-2 focus:ring-amber-500/20">
                        <option value="overview">Overview</option>
                        <option value="tasks">Key Tasks</option>
                        <option value="dates">Key Dates</option>
                        <option value="contacts">Contacts</option>
                        <option value="systems">Systems & Tools</option>
                        <option value="pitfalls">Watch Out For</option>
                        <option value="tips" selected>Pro Tips</option>
                        <option value="related">Related Topics</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Knowledge Point</label>
                    <textarea id="add-point-content" rows="4" placeholder="Enter the knowledge point..." class="w-full px-4 py-3 rounded-lg bg-surface-100 border-0 text-surface-700 placeholder:text-surface-400 focus:outline-none focus:ring-2 focus:ring-amber-500/20 resize-none"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-surface-200 bg-surface-50 flex gap-3">
                <button onclick="closeAddPointModal()" class="flex-1 px-4 py-2.5 rounded-xl border border-surface-200 text-surface-600 hover:bg-surface-100 transition-all font-medium">
                    Cancel
                </button>
                <button onclick="saveNewKnowledgePoint()" class="flex-1 px-4 py-2.5 rounded-xl bg-amber-500 hover:bg-amber-600 text-white transition-all font-semibold">
                    Add Point
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Knowledge Point Modal (Story 5.3) -->
    <div id="edit-point-modal" class="fixed inset-0 bg-surface-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface-0 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
            <div class="px-6 py-4 border-b border-surface-200 bg-gradient-to-r from-brand-50 to-surface-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-white">edit</span>
                        </div>
                        <div>
                            <h2 class="font-display text-xl text-surface-900">Edit Knowledge Point</h2>
                            <p class="text-sm text-surface-500">Refine captured information</p>
                        </div>
                    </div>
                    <button onclick="closeEditPointModal()" class="p-2 hover:bg-surface-100 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-surface-400">close</span>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-point-id">
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Knowledge Area</label>
                    <select id="edit-point-area" class="w-full h-10 px-3 rounded-lg bg-surface-100 border-0 text-surface-700 focus:outline-none focus:ring-2 focus:ring-brand-500/20">
                        <option value="overview">Overview</option>
                        <option value="tasks">Key Tasks</option>
                        <option value="dates">Key Dates</option>
                        <option value="contacts">Contacts</option>
                        <option value="systems">Systems & Tools</option>
                        <option value="pitfalls">Watch Out For</option>
                        <option value="tips">Pro Tips</option>
                        <option value="related">Related Topics</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Content</label>
                    <textarea id="edit-point-content" rows="4" class="w-full px-4 py-3 rounded-lg bg-surface-100 border-0 text-surface-700 placeholder:text-surface-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Status</label>
                    <div class="flex gap-2">
                        <button onclick="setEditStatus('draft')" id="edit-status-draft" class="flex-1 px-3 py-2 rounded-lg border-2 border-surface-200 text-surface-600 text-sm font-medium transition-all">Draft</button>
                        <button onclick="setEditStatus('reviewed')" id="edit-status-reviewed" class="flex-1 px-3 py-2 rounded-lg border-2 border-surface-200 text-surface-600 text-sm font-medium transition-all">Reviewed</button>
                        <button onclick="setEditStatus('approved')" id="edit-status-approved" class="flex-1 px-3 py-2 rounded-lg border-2 border-surface-200 text-surface-600 text-sm font-medium transition-all">Approved</button>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-surface-200 bg-surface-50 flex gap-3">
                <button onclick="deleteKnowledgePoint()" class="px-4 py-2.5 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 transition-all font-medium">
                    <span class="material-symbols-outlined text-[18px]">delete</span>
                </button>
                <button onclick="closeEditPointModal()" class="flex-1 px-4 py-2.5 rounded-xl border border-surface-200 text-surface-600 hover:bg-surface-100 transition-all font-medium">
                    Cancel
                </button>
                <button onclick="saveEditedKnowledgePoint()" class="flex-1 px-4 py-2.5 rounded-xl bg-brand-500 hover:bg-brand-600 text-white transition-all font-semibold">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Workflow Diagram Modal (Story 5.4) -->
    <div id="workflow-modal" class="fixed inset-0 bg-surface-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface-0 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-surface-200 bg-gradient-to-r from-purple-50 to-surface-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-white">schema</span>
                        </div>
                        <div>
                            <h2 id="workflow-modal-title" class="font-display text-xl text-surface-900">Workflow Diagram</h2>
                            <p id="workflow-modal-subtitle" class="text-sm text-surface-500">Process workflow visualization</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="workflow-status-badge" class="px-2 py-0.5 bg-surface-100 text-surface-500 text-[10px] font-bold rounded-full uppercase">Draft</span>
                        <button onclick="closeWorkflowModal()" class="p-2 hover:bg-surface-100 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-surface-400">close</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-hidden flex">
                <!-- Diagram View -->
                <div id="workflow-diagram-container" class="flex-1 p-6 overflow-auto bg-surface-50 flex items-center justify-center">
                    <div id="workflow-diagram" class="mermaid bg-white p-6 rounded-xl shadow-sm border border-surface-200">
                        <!-- Mermaid diagram rendered here -->
                    </div>
                </div>

                <!-- Code Editor (toggle) -->
                <div id="workflow-editor-panel" class="w-96 border-l border-surface-200 flex flex-col hidden">
                    <div class="px-4 py-3 border-b border-surface-200 bg-surface-50">
                        <h3 class="font-semibold text-sm text-surface-700">Edit Mermaid Code</h3>
                    </div>
                    <textarea id="workflow-code-editor" class="flex-1 p-4 font-mono text-sm text-surface-700 bg-surface-0 border-0 focus:outline-none resize-none" placeholder="flowchart TD..."></textarea>
                    <div class="px-4 py-3 border-t border-surface-200 bg-surface-50">
                        <button onclick="previewWorkflowCode()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-semibold transition-colors">
                            Preview Changes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-surface-200 bg-surface-50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button onclick="toggleWorkflowEditor()" id="toggle-editor-btn" class="flex items-center gap-2 px-3 py-2 rounded-lg border border-surface-200 text-surface-600 hover:bg-surface-100 transition-all text-sm font-medium">
                        <span class="material-symbols-outlined text-[18px]">code</span>
                        <span id="toggle-editor-text">Edit Code</span>
                    </button>
                    <button onclick="regenerateWorkflow()" class="flex items-center gap-2 px-3 py-2 rounded-lg border border-surface-200 text-surface-600 hover:bg-surface-100 transition-all text-sm font-medium">
                        <span class="material-symbols-outlined text-[18px]">refresh</span>
                        Regenerate
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="setWorkflowStatus('reviewed')" class="px-4 py-2 rounded-lg border border-amber-200 text-amber-600 hover:bg-amber-50 transition-all text-sm font-medium">
                        Mark Reviewed
                    </button>
                    <button onclick="setWorkflowStatus('approved')" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition-all text-sm font-semibold">
                        Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Summary Modal (Story 2.4) -->
    <div id="summary-modal" class="fixed inset-0 bg-surface-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface-0 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-surface-200 bg-gradient-to-r from-brand-50 to-emerald-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-white">summarize</span>
                        </div>
                        <div>
                            <h2 class="font-display text-xl text-surface-900">Knowledge Summary</h2>
                            <p class="text-sm text-surface-500">Review what was captured</p>
                        </div>
                    </div>
                    <button onclick="closeSummaryModal()" class="p-2 hover:bg-surface-100 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-surface-400">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Stats Row -->
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-surface-50 rounded-xl p-3 text-center">
                        <p id="stat-messages" class="text-2xl font-bold text-brand-600">0</p>
                        <p class="text-xs text-surface-500">Messages</p>
                    </div>
                    <div class="bg-surface-50 rounded-xl p-3 text-center">
                        <p id="stat-duration" class="text-2xl font-bold text-brand-600">0m</p>
                        <p class="text-xs text-surface-500">Duration</p>
                    </div>
                    <div class="bg-surface-50 rounded-xl p-3 text-center">
                        <p id="stat-topics" class="text-2xl font-bold text-emerald-600">0</p>
                        <p class="text-xs text-surface-500">Topics</p>
                    </div>
                    <div class="bg-surface-50 rounded-xl p-3 text-center">
                        <p id="stat-insights" class="text-2xl font-bold text-emerald-600">0</p>
                        <p class="text-xs text-surface-500">Insights</p>
                    </div>
                </div>

                <!-- Coverage Indicator -->
                <div class="bg-surface-50 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-surface-700">Coverage Depth</span>
                        <span id="coverage-badge" class="px-2 py-1 rounded-full text-xs font-bold uppercase"></span>
                    </div>
                    <div class="w-full bg-surface-200 rounded-full h-2">
                        <div id="coverage-bar" class="h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="coverage-text" class="text-xs text-surface-500 mt-2"></p>
                </div>

                <!-- Topics Covered -->
                <div>
                    <h3 class="text-sm font-bold text-surface-700 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-emerald-500 text-[18px]">check_circle</span>
                        Topics Covered
                    </h3>
                    <div id="topics-list" class="flex flex-wrap gap-2">
                        <!-- Topics will be inserted here -->
                    </div>
                </div>

                <!-- Key Insights -->
                <div>
                    <h3 class="text-sm font-bold text-surface-700 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-brand-500 text-[18px]">lightbulb</span>
                        Key Insights
                    </h3>
                    <ul id="insights-list" class="space-y-2 text-sm text-surface-600">
                        <!-- Insights will be inserted here -->
                    </ul>
                </div>

                <!-- Gaps / Areas Not Covered -->
                <div>
                    <h3 class="text-sm font-bold text-surface-700 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-amber-500 text-[18px]">warning</span>
                        Areas Not Yet Covered
                    </h3>
                    <div id="gaps-list" class="flex flex-wrap gap-2">
                        <!-- Gaps will be inserted here -->
                    </div>
                </div>

                <!-- Frameworks -->
                <div id="frameworks-section" class="hidden">
                    <h3 class="text-sm font-bold text-surface-700 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-500 text-[18px]">account_tree</span>
                        Frameworks & Processes
                    </h3>
                    <div id="frameworks-list" class="flex flex-wrap gap-2">
                        <!-- Frameworks will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Modal Footer - Actions -->
            <div class="px-6 py-4 border-t border-surface-200 bg-surface-50">
                <p class="text-sm text-surface-600 mb-4 text-center">What would you like to do next?</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="continueInterview()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl border-2 border-surface-200 text-surface-700 hover:border-brand-300 hover:bg-brand-50 transition-all font-medium">
                        <span class="material-symbols-outlined text-[20px]">play_arrow</span>
                        Continue Interview
                    </button>
                    <button onclick="endAndBuildPersona()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-brand-600 text-white hover:from-brand-600 hover:to-brand-700 transition-all font-semibold shadow-lg shadow-brand-500/25">
                        <span class="material-symbols-outlined text-[20px]">auto_awesome</span>
                        Build Persona
                    </button>
                    <button onclick="endInterview()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl border border-surface-200 text-surface-500 hover:bg-surface-100 transition-all text-sm">
                        <span class="material-symbols-outlined text-[18px]">stop_circle</span>
                        End Without Persona
                    </button>
                    <button onclick="reviewInDetail()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl border border-surface-200 text-surface-500 hover:bg-surface-100 transition-all text-sm">
                        <span class="material-symbols-outlined text-[18px]">visibility</span>
                        Review Snapshots
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="ui.js"></script>
    <script>
        // Story 2.4: Knowledge Summary Modal Functions

        // Show summary modal with interview data
        async function showSummaryModal() {
            if (!interviewId) return;

            try {
                const res = await fetch(`/interviews/${interviewId}/summary`);
                const summary = await res.json();

                // Update stats
                document.getElementById('stat-messages').textContent = summary.messageCount || 0;
                document.getElementById('stat-duration').textContent = summary.duration ? `${summary.duration}m` : '0m';
                document.getElementById('stat-topics').textContent = summary.topicsCovered?.length || 0;
                document.getElementById('stat-insights').textContent = summary.keyInsights?.length || 0;

                // Update coverage indicator
                const coveragePercent = summary.coverage?.percent || 0;
                const coverageDepth = summary.coverage?.depth || 'shallow';
                const coverageBar = document.getElementById('coverage-bar');
                const coverageBadge = document.getElementById('coverage-badge');
                const coverageText = document.getElementById('coverage-text');

                coverageBar.style.width = `${coveragePercent}%`;

                if (coverageDepth === 'deep') {
                    coverageBar.className = 'h-2 rounded-full transition-all duration-500 bg-emerald-500';
                    coverageBadge.className = 'px-2 py-1 rounded-full text-xs font-bold uppercase bg-emerald-100 text-emerald-700';
                    coverageBadge.textContent = 'Deep';
                } else if (coverageDepth === 'moderate') {
                    coverageBar.className = 'h-2 rounded-full transition-all duration-500 bg-amber-500';
                    coverageBadge.className = 'px-2 py-1 rounded-full text-xs font-bold uppercase bg-amber-100 text-amber-700';
                    coverageBadge.textContent = 'Moderate';
                } else {
                    coverageBar.className = 'h-2 rounded-full transition-all duration-500 bg-red-400';
                    coverageBadge.className = 'px-2 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-700';
                    coverageBadge.textContent = 'Shallow';
                }

                coverageText.textContent = `${coveragePercent}% of expected ${summary.role} topics covered`;

                // Update topics list
                const topicsList = document.getElementById('topics-list');
                topicsList.innerHTML = (summary.topicsCovered || []).map(topic =>
                    `<span class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-sm border border-emerald-200">${topic}</span>`
                ).join('') || '<span class="text-surface-400 text-sm">No topics captured yet</span>';

                // Update insights list
                const insightsList = document.getElementById('insights-list');
                insightsList.innerHTML = (summary.keyInsights || []).slice(0, 8).map(insight =>
                    `<li class="flex items-start gap-2">
                        <span class="material-symbols-outlined text-brand-400 text-[16px] mt-0.5 flex-shrink-0">arrow_right</span>
                        <span>${insight}</span>
                    </li>`
                ).join('') || '<li class="text-surface-400">No insights captured yet</li>';

                // Update gaps list
                const gapsList = document.getElementById('gaps-list');
                const allGaps = [...(summary.coverage?.uncoveredExpected || []), ...(summary.gaps || [])];
                const uniqueGaps = [...new Set(allGaps)].slice(0, 10);
                gapsList.innerHTML = uniqueGaps.map(gap =>
                    `<span class="px-3 py-1 bg-amber-50 text-amber-700 rounded-full text-sm border border-amber-200">${gap}</span>`
                ).join('') || '<span class="text-surface-400 text-sm">No gaps identified</span>';

                // Update frameworks
                const frameworksSection = document.getElementById('frameworks-section');
                const frameworksList = document.getElementById('frameworks-list');
                if (summary.frameworksMentioned && summary.frameworksMentioned.length > 0) {
                    frameworksSection.classList.remove('hidden');
                    frameworksList.innerHTML = summary.frameworksMentioned.map(fw =>
                        `<span class="px-3 py-1 bg-purple-50 text-purple-700 rounded-full text-sm border border-purple-200">${fw}</span>`
                    ).join('');
                } else {
                    frameworksSection.classList.add('hidden');
                }

                // Show modal
                document.getElementById('summary-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading summary:', error);
                addMessage('System', 'Error loading interview summary.');
            }
        }

        function closeSummaryModal() {
            document.getElementById('summary-modal').classList.add('hidden');
        }

        function continueInterview() {
            closeSummaryModal();
            addMessage('System', 'Continuing interview. Feel free to explore more topics or say "let\'s finish" when done.');
            messageInput.focus();
        }

        async function endInterview() {
            closeSummaryModal();
            try {
                await fetch(`/interviews/${interviewId}/complete`, { method: 'POST' });
                addMessage('System', 'Interview marked as complete. Thank you for sharing your knowledge!');
            } catch (error) {
                addMessage('System', 'Error completing interview.');
            }
        }

        async function endAndBuildPersona() {
            closeSummaryModal();
            addMessage('System', 'Completing interview and building persona...');

            try {
                // First complete the interview
                await fetch(`/interviews/${interviewId}/complete`, { method: 'POST' });

                // Then build persona
                const res = await fetch('/personas/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewId })
                });
                const persona = await res.json();
                addMessage('System', `Persona created successfully! ID: ${persona.id}. View it in the Personas section.`);
            } catch (error) {
                addMessage('System', 'Error building persona. Please try again.');
            }
        }

        function reviewInDetail() {
            closeSummaryModal();
            // Open snapshots in new tab or navigate
            window.open(`/interviews/${interviewId}/snapshots`, '_blank');
        }

        // Additional functions for new features
        async function createSnapshot() {
            if (!interviewId) return;

            try {
                const res = await fetch(`/interviews/${interviewId}/note-snapshot`, { method: 'POST' });
                const snapshot = await res.json();
                addMessage('System', `Snapshot created! Captured ${snapshot.topicsCovered?.length || 0} topics and ${snapshot.keyInsights?.length || 0} key insights.`);
            } catch (error) {
                addMessage('System', 'Error creating snapshot. Please try again.');
            }
        }

        async function buildPersona() {
            if (!interviewId) return;

            // Check topic coverage first
            try {
                const progressRes = await fetch(`/interviews/${interviewId}/topic-progress`);
                if (progressRes.ok) {
                    const progress = await progressRes.json();
                    const percent = (progress.summary.completed / progress.summary.total) * 100;

                    if (percent < 70) {
                        const proceed = confirm(
                            `Only ${Math.round(percent)}% of topics have been covered (${progress.summary.completed}/${progress.summary.total}).\n\n` +
                            `Building a persona now may result in incomplete knowledge capture.\n\n` +
                            `Do you want to continue anyway?`
                        );
                        if (!proceed) return;
                    }
                }
            } catch (e) {
                // If we can't check progress, continue anyway
            }

            addMessage('System', 'Building persona from interview insights...');

            try {
                const res = await fetch('/personas/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewId })
                });
                const persona = await res.json();
                addMessage('System', `Persona created successfully! ID: ${persona.id}. View it in the Personas section.`);
            } catch (error) {
                addMessage('System', 'Error building persona. Please try again.');
            }
        }

        // Story 5.2: Topic Sidebar Functions
        let topicSidebarVisible = false;

        function toggleTopicSidebar() {
            const sidebar = document.getElementById('topic-sidebar');
            topicSidebarVisible = !topicSidebarVisible;

            if (topicSidebarVisible) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                loadTopicProgress();
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
            }
        }

        async function loadTopicProgress() {
            if (!interviewId) return;

            try {
                const res = await fetch(`/interviews/${interviewId}/topic-progress`);
                if (!res.ok) {
                    const topicList = document.getElementById('topic-list');
                    topicList.innerHTML = `
                        <div class="text-center text-surface-400 py-8">
                            <span class="material-symbols-outlined text-3xl mb-2 block">info</span>
                            <p class="text-sm">Topic tracking not available for this interview</p>
                        </div>
                    `;
                    return;
                }

                const data = await res.json();
                renderTopicList(data);
            } catch (error) {
                console.error('Error loading topic progress:', error);
            }
        }

        function renderTopicList(data) {
            const topicList = document.getElementById('topic-list');
            const progressBar = document.getElementById('topic-progress-bar');
            const progressText = document.getElementById('topic-progress-text');
            const coverageIndicator = document.getElementById('coverage-indicator');
            const buildPersonaBtn = document.getElementById('build-persona-btn');
            const buildPersonaText = document.getElementById('build-persona-text');

            // Update progress bar
            const completedCount = data.summary.completed;
            const totalCount = data.summary.total;
            const percent = (completedCount / totalCount) * 100;
            const meetsThreshold = percent >= 70;

            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${completedCount}/${totalCount}`;

            // Update coverage indicator
            if (coverageIndicator) {
                if (meetsThreshold) {
                    coverageIndicator.innerHTML = `
                        <div class="flex items-center justify-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-emerald-500 text-[18px]">check_circle</span>
                            <span class="text-emerald-700 font-medium">Ready to build persona!</span>
                        </div>
                    `;
                } else {
                    const topicsNeeded = Math.ceil(totalCount * 0.7) - completedCount;
                    coverageIndicator.innerHTML = `
                        <div class="flex items-center justify-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-amber-500 text-[18px]">info</span>
                            <span class="text-surface-600">Complete <span class="font-semibold">${topicsNeeded} more</span> topic${topicsNeeded !== 1 ? 's' : ''} to build persona</span>
                        </div>
                    `;
                }
            }

            // Update Build Persona button
            if (buildPersonaBtn && buildPersonaText) {
                if (meetsThreshold) {
                    buildPersonaBtn.disabled = false;
                    buildPersonaBtn.title = 'Build persona from captured knowledge';
                    buildPersonaBtn.classList.remove('bg-surface-400');
                    buildPersonaBtn.classList.add('bg-brand-600', 'hover:bg-brand-700');
                    buildPersonaText.textContent = `Build Persona (${Math.round(percent)}%)`;
                } else {
                    buildPersonaBtn.disabled = false; // Allow with warning
                    buildPersonaBtn.title = `Only ${Math.round(percent)}% coverage - consider completing more topics`;
                    buildPersonaText.textContent = `Build Persona (${Math.round(percent)}%)`;
                }
            }

            // Render topic list
            topicList.innerHTML = data.topics.map(topic => {
                const statusIcon = topic.progress.status === 'complete' ? 'check_circle' :
                                   topic.progress.status === 'in-progress' ? 'pending' : 'radio_button_unchecked';
                const statusColor = topic.progress.status === 'complete' ? 'text-emerald-500' :
                                    topic.progress.status === 'in-progress' ? 'text-amber-500' : 'text-surface-300';
                const bgColor = topic.isCurrent ? 'bg-purple-50 border-purple-200' : 'bg-surface-50 border-surface-200 hover:border-purple-200';
                const currentBadge = topic.isCurrent ? '<span class="px-2 py-0.5 bg-purple-100 text-purple-600 text-[10px] font-bold rounded-full uppercase">Current</span>' : '';
                const hasWorkflow = topic.progress.hasWorkflow;

                return `
                    <button onclick="selectTopic('${topic.id}')" class="w-full text-left p-3 rounded-xl border ${bgColor} transition-all group">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined ${statusColor} text-[20px] mt-0.5">${statusIcon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="font-medium text-surface-800 text-sm truncate">${topic.name}</p>
                                    ${currentBadge}
                                </div>
                                <p class="text-xs text-surface-500 line-clamp-2">${topic.description}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    ${topic.isProcessOriented ? `
                                        <span class="inline-flex items-center gap-1 text-[10px] text-purple-600">
                                            <span class="material-symbols-outlined text-[12px]">account_tree</span>Process
                                        </span>
                                        ${hasWorkflow ? `
                                            <button onclick="event.stopPropagation(); viewWorkflow('${topic.id}', '${topic.progress.workflowId}')" class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-600 text-[10px] font-medium hover:bg-emerald-200 transition-colors" title="View workflow diagram">
                                                <span class="material-symbols-outlined text-[12px]">schema</span>Workflow
                                            </button>
                                        ` : `
                                            <button onclick="event.stopPropagation(); generateWorkflow('${topic.id}')" class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-purple-100 text-purple-600 text-[10px] font-medium hover:bg-purple-200 transition-colors" title="Generate workflow diagram">
                                                <span class="material-symbols-outlined text-[12px]">add_chart</span>Generate
                                            </button>
                                        `}
                                    ` : ''}
                                </div>
                            </div>
                            ${topic.progress.status !== 'complete' ? `
                                <button onclick="event.stopPropagation(); completeTopic('${topic.id}')" class="p-1 rounded-lg hover:bg-emerald-100 text-surface-400 hover:text-emerald-600 transition-colors opacity-0 group-hover:opacity-100" title="Mark as complete">
                                    <span class="material-symbols-outlined text-[18px]">check</span>
                                </button>
                            ` : ''}
                        </div>
                    </button>
                `;
            }).join('');
        }

        async function selectTopic(topicId) {
            if (!interviewId) return;

            try {
                const res = await fetch(`/interviews/${interviewId}/topic/${topicId}/select`, {
                    method: 'POST'
                });
                if (res.ok) {
                    loadTopicProgress();
                    addMessage('System', `Now focusing on topic: ${topicId.replace(/-/g, ' ')}`);
                }
            } catch (error) {
                console.error('Error selecting topic:', error);
            }
        }

        async function completeTopic(topicId) {
            if (!interviewId) return;

            try {
                const res = await fetch(`/interviews/${interviewId}/topic/${topicId}/complete`, {
                    method: 'POST'
                });
                if (res.ok) {
                    const data = await res.json();
                    loadTopicProgress();
                    addMessage('System', `Topic "${topicId.replace(/-/g, ' ')}" marked as complete. ${data.newCurrentTopicId ? `Moving to: ${data.newCurrentTopicId.replace(/-/g, ' ')}` : ''}`);
                }
            } catch (error) {
                console.error('Error completing topic:', error);
            }
        }

        function takeBreak() {
            // Create a snapshot before leaving
            createSnapshot();

            // Show confirmation message
            const chatContainer = document.getElementById('chat-container');
            const breakMessage = document.createElement('div');
            breakMessage.className = 'flex justify-center my-4';
            breakMessage.innerHTML = `
                <div class="bg-emerald-50 border border-emerald-200 rounded-xl px-6 py-4 text-center max-w-md">
                    <span class="material-symbols-outlined text-emerald-500 text-3xl mb-2 block">coffee</span>
                    <p class="font-semibold text-emerald-800 mb-1">Progress Saved!</p>
                    <p class="text-sm text-emerald-600 mb-3">Your interview has been saved. You can return anytime via the Dashboard.</p>
                    <a href="dashboard.html" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <span class="material-symbols-outlined text-[16px]">arrow_back</span>
                        Go to Dashboard
                    </a>
                </div>
            `;
            chatContainer.appendChild(breakMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Auto-refresh topic progress periodically when sidebar is open
        setInterval(() => {
            if (topicSidebarVisible && interviewId) {
                loadTopicProgress();
            }
        }, 30000); // Refresh every 30 seconds

        // ============================================
        // Story 5.3: Knowledge Review Panel Functions
        // ============================================

        let reviewSidebarVisible = false;
        let knowledgeData = null;
        let editingPointStatus = 'draft';

        // Area labels for display
        const AREA_LABELS = {
            overview: 'Overview',
            tasks: 'Key Tasks',
            dates: 'Key Dates',
            contacts: 'Contacts',
            systems: 'Systems & Tools',
            pitfalls: 'Watch Out For',
            tips: 'Pro Tips',
            related: 'Related Topics'
        };

        // Area icons
        const AREA_ICONS = {
            overview: 'info',
            tasks: 'task_alt',
            dates: 'calendar_today',
            contacts: 'contacts',
            systems: 'computer',
            pitfalls: 'warning',
            tips: 'lightbulb',
            related: 'link'
        };

        function toggleReviewSidebar() {
            const sidebar = document.getElementById('review-sidebar');
            const topicSidebar = document.getElementById('topic-sidebar');
            reviewSidebarVisible = !reviewSidebarVisible;

            if (reviewSidebarVisible) {
                // Close topic sidebar if open
                if (topicSidebarVisible) {
                    topicSidebar.classList.add('hidden');
                    topicSidebar.classList.remove('flex');
                    topicSidebarVisible = false;
                }
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                loadKnowledgePoints();
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
            }
        }

        async function loadKnowledgePoints() {
            if (!interviewId) return;

            try {
                const res = await fetch(`/interviews/${interviewId}/knowledge-points`);
                if (!res.ok) {
                    const reviewList = document.getElementById('review-list');
                    reviewList.innerHTML = `
                        <div class="text-center text-surface-400 py-8">
                            <span class="material-symbols-outlined text-3xl mb-2 block">info</span>
                            <p class="text-sm">No knowledge points yet</p>
                            <p class="text-xs mt-1">Create a snapshot to auto-extract insights</p>
                        </div>
                    `;
                    return;
                }

                knowledgeData = await res.json();
                renderKnowledgePoints(knowledgeData);
                updateAddPointTopics(knowledgeData.topics);
            } catch (error) {
                console.error('Error loading knowledge points:', error);
            }
        }

        function renderKnowledgePoints(data) {
            const reviewList = document.getElementById('review-list');
            const pointsText = document.getElementById('review-points-text');
            const draftCount = document.getElementById('review-draft-count');
            const reviewedCount = document.getElementById('review-reviewed-count');
            const approvedCount = document.getElementById('review-approved-count');

            // Update stats
            pointsText.textContent = `${data.summary.totalPoints} point${data.summary.totalPoints !== 1 ? 's' : ''}`;
            draftCount.textContent = `${data.summary.draftPoints} draft`;
            reviewedCount.textContent = `${data.summary.reviewedPoints} reviewed`;
            approvedCount.textContent = `${data.summary.approvedPoints} approved`;

            // Filter topics that have points
            const topicsWithPoints = data.topics.filter(topic => {
                return Object.values(topic.areas).some(points => points.length > 0);
            });

            if (topicsWithPoints.length === 0) {
                reviewList.innerHTML = `
                    <div class="text-center text-surface-400 py-8">
                        <span class="material-symbols-outlined text-3xl mb-2 block">lightbulb</span>
                        <p class="text-sm">No knowledge points yet</p>
                        <p class="text-xs mt-1">Create a snapshot or add points manually</p>
                    </div>
                `;
                return;
            }

            // Render accordion by topic
            reviewList.innerHTML = topicsWithPoints.map(topic => {
                const statusBadge = getValidationStatusBadge(topic.validationStatus);
                const areasWithPoints = Object.entries(topic.areas).filter(([_, points]) => points.length > 0);

                return `
                    <div class="topic-accordion rounded-xl border border-surface-200 overflow-hidden">
                        <button onclick="toggleTopicAccordion('${topic.id}')" class="w-full flex items-center justify-between p-3 bg-surface-50 hover:bg-surface-100 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-surface-400 text-[18px] accordion-icon-${topic.id} transition-transform">expand_more</span>
                                <span class="font-medium text-surface-800 text-sm">${topic.name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-surface-400">${countTopicPoints(topic)} pts</span>
                                ${statusBadge}
                            </div>
                        </button>
                        <div id="topic-content-${topic.id}" class="border-t border-surface-200">
                            ${areasWithPoints.map(([area, points]) => renderAreaSection(topic.id, area, points)).join('')}
                            <button onclick="addKnowledgePointForTopic('${topic.id}')" class="w-full flex items-center justify-center gap-2 px-3 py-2 text-amber-600 hover:bg-amber-50 transition-colors text-xs font-medium border-t border-surface-200">
                                <span class="material-symbols-outlined text-[14px]">add</span>
                                Add to this topic
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function countTopicPoints(topic) {
            return Object.values(topic.areas).reduce((sum, points) => sum + points.length, 0);
        }

        function getValidationStatusBadge(status) {
            switch (status) {
                case 'approved':
                    return '<span class="px-2 py-0.5 bg-emerald-100 text-emerald-600 text-[10px] font-bold rounded-full uppercase">Approved</span>';
                case 'reviewed':
                    return '<span class="px-2 py-0.5 bg-amber-100 text-amber-600 text-[10px] font-bold rounded-full uppercase">Reviewed</span>';
                default:
                    return '<span class="px-2 py-0.5 bg-surface-100 text-surface-500 text-[10px] font-bold rounded-full uppercase">Draft</span>';
            }
        }

        function renderAreaSection(topicId, area, points) {
            const areaLabel = AREA_LABELS[area] || area;
            const areaIcon = AREA_ICONS[area] || 'circle';

            return `
                <div class="area-section border-b border-surface-100 last:border-b-0">
                    <div class="flex items-center gap-2 px-3 py-2 bg-surface-50/50">
                        <span class="material-symbols-outlined text-surface-400 text-[16px]">${areaIcon}</span>
                        <span class="text-xs font-semibold text-surface-600 uppercase tracking-wide">${areaLabel}</span>
                        <span class="text-xs text-surface-400">(${points.length})</span>
                    </div>
                    <div class="space-y-1 p-2">
                        ${points.map(point => renderKnowledgePoint(point)).join('')}
                    </div>
                </div>
            `;
        }

        function renderKnowledgePoint(point) {
            const statusIcon = point.status === 'approved' ? 'check_circle' :
                               point.status === 'reviewed' ? 'pending' : 'radio_button_unchecked';
            const statusColor = point.status === 'approved' ? 'text-emerald-500' :
                                point.status === 'reviewed' ? 'text-amber-500' : 'text-surface-300';
            const sourceIcon = point.source === 'snapshot' ? 'auto_awesome' : 'person';

            return `
                <div class="group flex items-start gap-2 p-2 rounded-lg hover:bg-surface-50 transition-colors">
                    <span class="material-symbols-outlined ${statusColor} text-[16px] mt-0.5 flex-shrink-0">${statusIcon}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-surface-700 leading-snug">${point.content}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="material-symbols-outlined text-surface-300 text-[12px]">${sourceIcon}</span>
                            <span class="text-[10px] text-surface-400">${point.source === 'snapshot' ? 'Auto-extracted' : 'Manual'}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        ${point.status !== 'approved' ? `
                            <button onclick="approvePoint('${point.id}')" class="p-1 rounded hover:bg-emerald-100 text-surface-400 hover:text-emerald-600 transition-colors" title="Approve">
                                <span class="material-symbols-outlined text-[16px]">check</span>
                            </button>
                        ` : ''}
                        <button onclick="editPoint('${point.id}')" class="p-1 rounded hover:bg-brand-100 text-surface-400 hover:text-brand-600 transition-colors" title="Edit">
                            <span class="material-symbols-outlined text-[16px]">edit</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleTopicAccordion(topicId) {
            const content = document.getElementById(`topic-content-${topicId}`);
            const icon = document.querySelector(`.accordion-icon-${topicId}`);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        function updateAddPointTopics(topics) {
            const select = document.getElementById('add-point-topic');
            select.innerHTML = topics.map(topic =>
                `<option value="${topic.id}">${topic.name}</option>`
            ).join('');
        }

        // Quick approve a point
        async function approvePoint(pointId) {
            if (!interviewId) return;

            try {
                await fetch(`/knowledge-points/${interviewId}/${pointId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'approved' })
                });
                loadKnowledgePoints();
            } catch (error) {
                console.error('Error approving point:', error);
            }
        }

        // Open edit modal for a point
        function editPoint(pointId) {
            if (!knowledgeData) return;

            // Find the point
            let point = null;
            for (const topic of knowledgeData.topics) {
                for (const points of Object.values(topic.areas)) {
                    const found = points.find(p => p.id === pointId);
                    if (found) {
                        point = found;
                        break;
                    }
                }
                if (point) break;
            }

            if (!point) return;

            // Populate edit modal
            document.getElementById('edit-point-id').value = pointId;
            document.getElementById('edit-point-area').value = point.area;
            document.getElementById('edit-point-content').value = point.content;
            editingPointStatus = point.status;
            updateEditStatusButtons();

            // Show modal
            document.getElementById('edit-point-modal').classList.remove('hidden');
        }

        function setEditStatus(status) {
            editingPointStatus = status;
            updateEditStatusButtons();
        }

        function updateEditStatusButtons() {
            const buttons = ['draft', 'reviewed', 'approved'];
            buttons.forEach(status => {
                const btn = document.getElementById(`edit-status-${status}`);
                if (status === editingPointStatus) {
                    btn.classList.remove('border-surface-200', 'text-surface-600');
                    if (status === 'approved') {
                        btn.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
                    } else if (status === 'reviewed') {
                        btn.classList.add('border-amber-500', 'bg-amber-50', 'text-amber-700');
                    } else {
                        btn.classList.add('border-surface-400', 'bg-surface-100', 'text-surface-700');
                    }
                } else {
                    btn.classList.add('border-surface-200', 'text-surface-600');
                    btn.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700',
                                         'border-amber-500', 'bg-amber-50', 'text-amber-700',
                                         'border-surface-400', 'bg-surface-100', 'text-surface-700');
                }
            });
        }

        function closeEditPointModal() {
            document.getElementById('edit-point-modal').classList.add('hidden');
        }

        async function saveEditedKnowledgePoint() {
            const pointId = document.getElementById('edit-point-id').value;
            const area = document.getElementById('edit-point-area').value;
            const content = document.getElementById('edit-point-content').value;

            if (!content.trim()) {
                alert('Content is required');
                return;
            }

            try {
                await fetch(`/knowledge-points/${interviewId}/${pointId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        area,
                        content: content.trim(),
                        status: editingPointStatus
                    })
                });
                closeEditPointModal();
                loadKnowledgePoints();
            } catch (error) {
                console.error('Error saving knowledge point:', error);
            }
        }

        async function deleteKnowledgePoint() {
            const pointId = document.getElementById('edit-point-id').value;

            if (!confirm('Are you sure you want to delete this knowledge point?')) {
                return;
            }

            try {
                await fetch(`/knowledge-points/${interviewId}/${pointId}`, {
                    method: 'DELETE'
                });
                closeEditPointModal();
                loadKnowledgePoints();
            } catch (error) {
                console.error('Error deleting knowledge point:', error);
            }
        }

        // Add knowledge point modal
        function addKnowledgePoint() {
            document.getElementById('add-point-content').value = '';
            document.getElementById('add-point-modal').classList.remove('hidden');
        }

        function addKnowledgePointForTopic(topicId) {
            document.getElementById('add-point-topic').value = topicId;
            document.getElementById('add-point-content').value = '';
            document.getElementById('add-point-modal').classList.remove('hidden');
        }

        function closeAddPointModal() {
            document.getElementById('add-point-modal').classList.add('hidden');
        }

        async function saveNewKnowledgePoint() {
            const topicId = document.getElementById('add-point-topic').value;
            const area = document.getElementById('add-point-area').value;
            const content = document.getElementById('add-point-content').value;

            if (!content.trim()) {
                alert('Content is required');
                return;
            }

            try {
                await fetch(`/interviews/${interviewId}/knowledge-points`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topicId,
                        area,
                        content: content.trim()
                    })
                });
                closeAddPointModal();
                loadKnowledgePoints();
                addMessage('System', 'Knowledge point added successfully.');
            } catch (error) {
                console.error('Error adding knowledge point:', error);
            }
        }

        // Auto-refresh knowledge points when sidebar is open
        setInterval(() => {
            if (reviewSidebarVisible && interviewId) {
                loadKnowledgePoints();
            }
        }, 30000);

        // ============================================
        // Story 5.4: Workflow Diagram Functions
        // ============================================

        let currentWorkflow = null;
        let workflowEditorVisible = false;

        // Generate a new workflow diagram for a topic
        async function generateWorkflow(topicId) {
            if (!interviewId) return;

            // Show loading state
            addMessage('System', 'Generating workflow diagram... This may take a moment.');

            try {
                const res = await fetch(`/interviews/${interviewId}/topics/${topicId}/workflow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) {
                    const error = await res.json();
                    addMessage('System', `Error: ${error.error}`);
                    return;
                }

                const workflow = await res.json();
                currentWorkflow = workflow;

                // Refresh topic progress to show workflow badge
                loadTopicProgress();

                // Show the workflow modal
                showWorkflowModal(workflow);

                addMessage('System', `Workflow diagram generated for "${workflow.topicName}". You can edit and approve it.`);
            } catch (error) {
                console.error('Error generating workflow:', error);
                addMessage('System', 'Failed to generate workflow diagram. Please try again.');
            }
        }

        // View an existing workflow
        async function viewWorkflow(topicId, workflowId) {
            if (!interviewId || !workflowId) return;

            try {
                const res = await fetch(`/workflows/${interviewId}/${workflowId}`);
                if (!res.ok) {
                    const error = await res.json();
                    alert(`Error: ${error.error}`);
                    return;
                }

                const workflow = await res.json();
                currentWorkflow = workflow;
                showWorkflowModal(workflow);
            } catch (error) {
                console.error('Error loading workflow:', error);
                alert('Failed to load workflow diagram.');
            }
        }

        // Show the workflow modal
        async function showWorkflowModal(workflow) {
            const modal = document.getElementById('workflow-modal');
            const title = document.getElementById('workflow-modal-title');
            const subtitle = document.getElementById('workflow-modal-subtitle');
            const statusBadge = document.getElementById('workflow-status-badge');
            const diagram = document.getElementById('workflow-diagram');
            const codeEditor = document.getElementById('workflow-code-editor');

            // Update header
            title.textContent = workflow.topicName || 'Workflow Diagram';
            subtitle.textContent = 'Process workflow visualization';

            // Update status badge
            updateWorkflowStatusBadge(workflow.status);

            // Update code editor
            codeEditor.value = workflow.mermaidCode;

            // Render Mermaid diagram
            await renderMermaidDiagram(workflow.mermaidCode);

            // Show modal
            modal.classList.remove('hidden');
        }

        // Render Mermaid diagram
        async function renderMermaidDiagram(code) {
            const diagram = document.getElementById('workflow-diagram');

            try {
                // Clear previous content
                diagram.innerHTML = '';

                // Generate unique ID for this render
                const id = 'mermaid-' + Math.random().toString(36).substring(2, 8);

                // Use Mermaid to render
                const { svg } = await mermaid.render(id, code);
                diagram.innerHTML = svg;
            } catch (error) {
                console.error('Mermaid render error:', error);
                diagram.innerHTML = `
                    <div class="text-center text-red-500 p-8">
                        <span class="material-symbols-outlined text-3xl mb-2 block">error</span>
                        <p class="text-sm font-medium">Failed to render diagram</p>
                        <p class="text-xs text-red-400 mt-1">${error.message || 'Invalid Mermaid syntax'}</p>
                    </div>
                `;
            }
        }

        function updateWorkflowStatusBadge(status) {
            const badge = document.getElementById('workflow-status-badge');
            badge.textContent = status.toUpperCase();

            badge.className = 'px-2 py-0.5 text-[10px] font-bold rounded-full uppercase ';
            if (status === 'approved') {
                badge.className += 'bg-emerald-100 text-emerald-600';
            } else if (status === 'reviewed') {
                badge.className += 'bg-amber-100 text-amber-600';
            } else {
                badge.className += 'bg-surface-100 text-surface-500';
            }
        }

        function closeWorkflowModal() {
            document.getElementById('workflow-modal').classList.add('hidden');
            workflowEditorVisible = false;
            document.getElementById('workflow-editor-panel').classList.add('hidden');
            document.getElementById('toggle-editor-text').textContent = 'Edit Code';
        }

        // Toggle code editor panel
        function toggleWorkflowEditor() {
            const editorPanel = document.getElementById('workflow-editor-panel');
            const toggleText = document.getElementById('toggle-editor-text');

            workflowEditorVisible = !workflowEditorVisible;

            if (workflowEditorVisible) {
                editorPanel.classList.remove('hidden');
                toggleText.textContent = 'Hide Code';
            } else {
                editorPanel.classList.add('hidden');
                toggleText.textContent = 'Edit Code';
            }
        }

        // Preview edited code
        async function previewWorkflowCode() {
            const code = document.getElementById('workflow-code-editor').value;
            await renderMermaidDiagram(code);

            // Update current workflow object (but don't save yet)
            if (currentWorkflow) {
                currentWorkflow.mermaidCode = code;
            }
        }

        // Regenerate workflow
        async function regenerateWorkflow() {
            if (!currentWorkflow || !interviewId) return;

            if (!confirm('This will regenerate the workflow diagram and replace the current one. Continue?')) {
                return;
            }

            closeWorkflowModal();
            await generateWorkflow(currentWorkflow.topicId);
        }

        // Set workflow status
        async function setWorkflowStatus(status) {
            if (!currentWorkflow || !interviewId) return;

            try {
                const res = await fetch(`/workflows/${interviewId}/${currentWorkflow.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mermaidCode: currentWorkflow.mermaidCode,
                        status
                    })
                });

                if (res.ok) {
                    const updated = await res.json();
                    currentWorkflow = updated;
                    updateWorkflowStatusBadge(status);

                    if (status === 'approved') {
                        addMessage('System', `Workflow for "${currentWorkflow.topicName}" has been approved.`);
                    } else {
                        addMessage('System', `Workflow for "${currentWorkflow.topicName}" marked as ${status}.`);
                    }

                    loadTopicProgress();
                }
            } catch (error) {
                console.error('Error updating workflow status:', error);
                alert('Failed to update workflow status.');
            }
        }
    </script>
</body>
</html>
