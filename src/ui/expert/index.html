<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Succession | My Tasks - Expert Portal</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': {
                            50: '#eef4ff', 100: '#d9e5ff', 200: '#bcd2ff', 300: '#8eb5ff',
                            400: '#598eff', 500: '#3366ff', 600: '#1a44f5', 700: '#1333e1',
                            800: '#162bb6', 900: '#182a8f',
                        },
                        'surface': {
                            0: '#ffffff', 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0',
                            300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569',
                            700: '#334155', 800: '#1e293b', 900: '#0f172a',
                        },
                        'expert': {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
                            400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
                        }
                    },
                    fontFamily: {
                        'display': ['"DM Serif Display"', 'serif'],
                        'body': ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 40px -10px rgba(51, 102, 255, 0.3)',
                        'card': '0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04)',
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>

<body class="bg-surface-50 font-body text-surface-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-surface-0 border-r border-surface-200/80 flex flex-col h-full flex-shrink-0">
        <div class="flex flex-col h-full p-5">
            <!-- Logo -->
            <div class="flex items-center gap-3 mb-10 px-1">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-expert-500 to-expert-600 flex items-center justify-center shadow-glow">
                    <span class="material-symbols-outlined text-white text-xl">school</span>
                </div>
                <div>
                    <h1 class="font-display text-xl text-surface-900 tracking-tight">Succession</h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] text-expert-600 font-medium">Expert Portal</p>
                </div>
            </div>

            <!-- Navigation - Expert Portal -->
            <nav class="flex flex-col gap-1 flex-1">
                <a href="index.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-expert-50 text-expert-600 transition-all">
                    <span class="material-symbols-outlined filled text-[20px]">task_alt</span>
                    <span class="text-sm font-semibold">My Tasks</span>
                </a>
                <a href="profile.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-surface-700 hover:bg-surface-100 transition-all">
                    <span class="material-symbols-outlined text-[20px]">person</span>
                    <span class="text-sm font-medium">My Profile</span>
                </a>
                <div class="flex-1"></div>
                <button onclick="logout()" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-surface-500 hover:text-red-600 hover:bg-red-50 transition-all">
                    <span class="material-symbols-outlined text-[20px]">logout</span>
                    <span class="text-sm font-medium">Sign Out</span>
                </button>
            </nav>

            <!-- User -->
            <div class="border-t border-surface-200/80 pt-5 mt-4">
                <div class="flex items-center gap-3 px-1">
                    <div id="user-avatar" class="w-9 h-9 rounded-full bg-gradient-to-br from-expert-400 to-expert-600 flex items-center justify-center text-white font-semibold text-sm">EX</div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-semibold text-surface-800 truncate">Loading...</p>
                        <p id="user-title" class="text-xs text-surface-400 truncate">Expert</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden">
        <!-- Header -->
        <header class="px-8 py-6 bg-surface-0 border-b border-surface-200/60">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="font-display text-2xl text-surface-900">My Tasks</h1>
                    <p class="text-sm text-surface-500 mt-1">Organize your knowledge into key responsibility areas</p>
                </div>
                <button onclick="openAddTaskModal()" class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-expert-500 to-expert-600 hover:from-expert-600 hover:to-expert-700 text-white rounded-xl font-semibold shadow-lg shadow-expert-500/25 transition-all">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                    Add Task
                </button>
            </div>

            <!-- Stats Row -->
            <div class="flex gap-6 mt-6">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-surface-100 flex items-center justify-center">
                        <span class="material-symbols-outlined text-surface-500 text-[18px]">task_alt</span>
                    </div>
                    <div>
                        <p id="stat-tasks" class="text-lg font-bold text-surface-800">0</p>
                        <p class="text-xs text-surface-400">Tasks</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-brand-100 flex items-center justify-center">
                        <span class="material-symbols-outlined text-brand-600 text-[18px]">folder</span>
                    </div>
                    <div>
                        <p id="stat-topics" class="text-lg font-bold text-brand-600">0</p>
                        <p class="text-xs text-surface-400">Topics</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tasks List -->
        <div id="tasks-container" class="flex-1 overflow-y-auto p-8">
            <div id="tasks-loading" class="text-center py-12">
                <span class="material-symbols-outlined text-4xl text-surface-300 animate-spin">progress_activity</span>
                <p class="text-sm text-surface-400 mt-2">Loading tasks...</p>
            </div>
            <div id="tasks-empty" class="hidden text-center py-12">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-surface-100 flex items-center justify-center">
                    <span class="material-symbols-outlined text-surface-300 text-4xl">task_alt</span>
                </div>
                <h3 class="font-semibold text-surface-700 mb-2">No tasks yet</h3>
                <p class="text-sm text-surface-400 mb-4">Add your first task to get started</p>
                <button onclick="openAddTaskModal()" class="inline-flex items-center gap-2 px-4 py-2.5 bg-expert-500 hover:bg-expert-600 text-white rounded-xl font-semibold transition-all">
                    <span class="material-symbols-outlined text-[20px]">add</span>
                    Add Your First Task
                </button>
            </div>
            <div id="tasks-list" class="hidden grid gap-4">
                <!-- Tasks will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-surface-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface-0 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
            <div class="px-6 py-4 border-b border-surface-200 bg-gradient-to-r from-expert-50 to-surface-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-expert-400 to-expert-600 flex items-center justify-center">
                            <span id="modal-icon" class="material-symbols-outlined text-white">add_circle</span>
                        </div>
                        <div>
                            <h2 id="modal-title" class="font-display text-xl text-surface-900">Add Task</h2>
                            <p id="modal-subtitle" class="text-sm text-surface-500">Define a key responsibility area</p>
                        </div>
                    </div>
                    <button onclick="closeTaskModal()" class="p-2 hover:bg-surface-100 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-surface-400">close</span>
                    </button>
                </div>
            </div>
            <form id="task-form" onsubmit="saveTask(event)" class="p-6 space-y-4">
                <input type="hidden" id="task-id">
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Task Name *</label>
                    <input type="text" id="task-name" required placeholder="e.g., Treasury Management" class="w-full h-11 px-4 rounded-lg bg-surface-100 border-0 text-surface-700 placeholder:text-surface-400 focus:outline-none focus:ring-2 focus:ring-expert-500/20">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-surface-700 mb-2">Description</label>
                    <textarea id="task-description" rows="3" placeholder="Brief description of what this task involves..." class="w-full px-4 py-3 rounded-lg bg-surface-100 border-0 text-surface-700 placeholder:text-surface-400 focus:outline-none focus:ring-2 focus:ring-expert-500/20 resize-none"></textarea>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeTaskModal()" class="flex-1 px-4 py-2.5 rounded-xl border border-surface-200 text-surface-600 hover:bg-surface-100 transition-all font-medium">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2.5 rounded-xl bg-expert-500 hover:bg-expert-600 text-white transition-all font-semibold">
                        Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Auth token
        const token = localStorage.getItem('authToken');
        let currentExpert = null;
        let allTasks = [];

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                window.location.href = '../login.html';
                return;
            }

            try {
                // Verify token and get expert profile
                const res = await fetch('/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error('Invalid token');
                }

                currentExpert = await res.json();
                updateUserDisplay();
                loadTasks();
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('authToken');
                window.location.href = '../login.html';
            }
        });

        function updateUserDisplay() {
            if (!currentExpert) return;

            const initials = currentExpert.name
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);

            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = currentExpert.name;
            document.getElementById('user-title').textContent = currentExpert.jobTitle || 'Expert';
        }

        async function loadTasks() {
            try {
                const res = await fetch('/tasks', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load tasks');

                allTasks = await res.json();
                renderTasks();
                updateStats();
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasks-loading').innerHTML = `
                    <span class="material-symbols-outlined text-4xl text-red-400">error</span>
                    <p class="text-sm text-surface-400 mt-2">Failed to load tasks</p>
                `;
            }
        }

        function updateStats() {
            const totalTopics = allTasks.reduce((sum, task) => sum + (task.topicCount || 0), 0);
            document.getElementById('stat-tasks').textContent = allTasks.length;
            document.getElementById('stat-topics').textContent = totalTopics;
        }

        function renderTasks() {
            const container = document.getElementById('tasks-list');
            const loading = document.getElementById('tasks-loading');
            const empty = document.getElementById('tasks-empty');

            loading.classList.add('hidden');

            if (allTasks.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.classList.remove('hidden');

            container.innerHTML = allTasks.map((task, index) => renderTaskCard(task, index, allTasks.length)).join('');
        }

        function renderTaskCard(task, index, totalTasks) {
            const topicText = task.topicCount === 1 ? '1 topic' : `${task.topicCount || 0} topics`;
            const isFirst = index === 0;
            const isLast = index === totalTasks - 1;
            const showReorder = totalTasks > 1;

            return `
                <div onclick="viewTask('${task.id}')" class="bg-surface-0 rounded-xl border border-surface-200/60 shadow-card hover:shadow-lg hover:border-expert-200 transition-all p-5 cursor-pointer group" data-task-id="${task.id}">
                    <div class="flex items-start gap-4">
                        ${showReorder ? `
                        <div class="flex flex-col gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); moveTask('${task.id}', 'up')"
                                class="p-1 rounded hover:bg-surface-100 text-surface-300 hover:text-surface-600 transition-colors ${isFirst ? 'invisible' : ''}"
                                ${isFirst ? 'disabled' : ''}>
                                <span class="material-symbols-outlined text-[16px]">keyboard_arrow_up</span>
                            </button>
                            <button onclick="event.stopPropagation(); moveTask('${task.id}', 'down')"
                                class="p-1 rounded hover:bg-surface-100 text-surface-300 hover:text-surface-600 transition-colors ${isLast ? 'invisible' : ''}"
                                ${isLast ? 'disabled' : ''}>
                                <span class="material-symbols-outlined text-[16px]">keyboard_arrow_down</span>
                            </button>
                        </div>
                        ` : ''}
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-expert-100 to-expert-200 flex items-center justify-center flex-shrink-0 group-hover:from-expert-200 group-hover:to-expert-300 transition-all">
                            <span class="material-symbols-outlined text-expert-600 text-[24px]">task_alt</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-surface-800 truncate group-hover:text-expert-700 transition-colors">${task.name}</h3>
                            </div>
                            ${task.description ? `<p class="text-sm text-surface-500 line-clamp-2 mb-2">${task.description}</p>` : ''}
                            <div class="flex items-center gap-3 text-xs text-surface-400">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[14px]">folder</span>
                                    ${topicText}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="event.stopPropagation(); editTask('${task.id}')" class="p-2 rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-600 transition-colors opacity-0 group-hover:opacity-100" title="Edit task">
                                <span class="material-symbols-outlined text-[18px]">edit</span>
                            </button>
                            <button onclick="event.stopPropagation(); deleteTask('${task.id}')" class="p-2 rounded-lg hover:bg-red-50 text-surface-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100" title="Delete task">
                                <span class="material-symbols-outlined text-[18px]">delete</span>
                            </button>
                            <span class="material-symbols-outlined text-surface-300 group-hover:text-expert-500 transition-colors ml-1">chevron_right</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function moveTask(taskId, direction) {
            const currentIndex = allTasks.findIndex(t => t.id === taskId);
            if (currentIndex === -1) return;

            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex >= allTasks.length) return;

            // Reorder locally for immediate feedback
            const taskIds = allTasks.map(t => t.id);
            [taskIds[currentIndex], taskIds[newIndex]] = [taskIds[newIndex], taskIds[currentIndex]];

            // Update UI immediately
            [allTasks[currentIndex], allTasks[newIndex]] = [allTasks[newIndex], allTasks[currentIndex]];
            renderTasks();

            try {
                const res = await fetch('/tasks/reorder', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ taskIds })
                });

                if (!res.ok) throw new Error('Failed to reorder tasks');
            } catch (error) {
                console.error('Error reordering tasks:', error);
                // Reload to get correct order on error
                loadTasks();
            }
        }

        function viewTask(taskId) {
            window.location.href = `task.html?id=${taskId}`;
        }

        // Modal functions
        function openAddTaskModal() {
            document.getElementById('modal-title').textContent = 'Add Task';
            document.getElementById('modal-subtitle').textContent = 'Define a key responsibility area';
            document.getElementById('modal-icon').textContent = 'add_circle';
            document.getElementById('task-id').value = '';
            document.getElementById('task-form').reset();
            document.getElementById('task-modal').classList.remove('hidden');
        }

        function editTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('modal-title').textContent = 'Edit Task';
            document.getElementById('modal-subtitle').textContent = 'Update task details';
            document.getElementById('modal-icon').textContent = 'edit';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-modal').classList.remove('hidden');
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.add('hidden');
        }

        async function saveTask(event) {
            event.preventDefault();

            const submitBtn = document.querySelector('#task-form button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            const taskId = document.getElementById('task-id').value;
            const name = document.getElementById('task-name').value.trim();
            const description = document.getElementById('task-description').value.trim();

            if (!name) {
                alert('Task name is required');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-symbols-outlined text-[18px] animate-spin">progress_activity</span> Saving...';

            const data = { name, description };

            try {
                let res;
                if (taskId) {
                    res = await fetch(`/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (!res.ok) throw new Error('Failed to save task');

                closeTaskModal();
                loadTasks();
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Failed to save task. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function deleteTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            const topicCount = task?.topicCount || 0;
            const message = topicCount > 0
                ? `Delete "${task.name}"? This will also delete ${topicCount} topic(s) and all their subtopics.`
                : `Delete "${task.name}"?`;

            if (!confirm(message)) return;

            // Show loading state on the card
            const card = document.querySelector(`[data-task-id="${taskId}"]`);
            if (card) {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            }

            try {
                const res = await fetch(`/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to delete task');
                loadTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task. Please try again.');
                // Restore card on error
                if (card) {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
